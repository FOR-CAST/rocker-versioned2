---
title: "`r params$image_name`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S %Z')`"
output:
  github_document:
    toc: true
    df_print: kable
    html_preview: false
params:
  image_name: ""
  inspect_file: ""
  apt_file: ""
  r_file: ""
  pip_file: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
knitr::opts_knit$set(root.dir = rprojroot::find_root_file(criterion = rprojroot::is_git_root))
```

```{r load_packages, include=FALSE}
library(jsonlite)
library(readr)
library(dplyr)
library(tibble)
library(tidyr)
library(tidyselect)
```

```{r}
.link_to_commit <- function(commit_hash) {
  base_url <- "https://github.com/rocker-org/rocker-versioned2/tree/"
  commit_short_hash <- commit_hash |>
    substr(1, 7)
  linked_text <- paste0("[`", commit_short_hash, "`](", base_url, commit_hash, ")")

  return(linked_text)
}

commit_link <- system("git rev-parse HEAD", intern = TRUE) |>
  .link_to_commit()

image_arch <- jsonlite::read_json(params$inspect_file) |>
  purrr::map_chr("Architecture")
```

*This report was generated from `r commit_link`, and based on the `r image_arch` architecture image.*

## Image info

```{r}
.unlist_and_enclose <- function(x) {
  chr <- dplyr::if_else(
    !is.null(unlist(x)),
    paste0("`", paste(unlist(x), collapse = "`, `"), "`"),
    ""
  )

  return(chr)
}

jsonlite::read_json(params$inspect_file) |>
  tibble::enframe() |>
  tidyr::hoist(
    .col = value,
    ImageID = "Id",
    "RepoTags",
    "RepoDigests",
    ImageSource = list("Config", "Labels", "org.opencontainers.image.source"),
    ImageRevision = list("Config", "Labels", "org.opencontainers.image.revision"),
    CreatedTime = "Created",
    "Size",
    Env = list("Config", "Env")
  ) |>
  dplyr::mutate(
    ImageID = paste0("`", ImageID, "`"),
    RepoTags = .unlist_and_enclose(RepoTags),
    RepoDigests = .unlist_and_enclose(RepoDigests),
    Size = paste0(format(round(Size / 10^6), big.mark = ","), "MB"),
    Env = paste(unlist(Env), collapse = ", ")
  ) |>
  dplyr::select(tidyselect:::where(is.character)) |>
  tidyr::pivot_longer(cols = tidyselect::everything())
```

## Installed packages

### apt packages

```{r}
readr::read_tsv(params$apt_file, col_names = FALSE) |>
  dplyr::transmute(
    package = X1,
    version = X2
  )
```

### R packages

```{r}
readr::read_table(params$r_file, skip = 1, col_names = FALSE) |>
  dplyr::transmute(
    package = X1,
    version = X2
  )
```

### Python3 pip packages

```{r}
try(
  readr::read_table(params$pip_file, skip = 2, col_names = FALSE) |>
    dplyr::transmute(
      package = X1,
      version = X2
    ),
  silent = TRUE
)
```
