---
- hosts: rocker-server-aws
  vars:
  tasks:
    - name: add docker gpg apt key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    - name: add docker repo
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu bionic stable
        state: present
    - name: update apt and install docker-ce
      apt: update_cache=yes name=docker-ce state=present
    - name: add nvidia-docker apt key
      apt_key:
        url: https://nvidia.github.io/nvidia-docker/gpgkey
        state: present
    - name: copy nvidia-docker.list
      get_url:
        url: https://nvidia.github.io/nvidia-docker/ubuntu20.04/nvidia-docker.list
        dest: /etc/apt/sources.list.d/nvidia-docker.list
    - name: install system packages
      apt:
        name:
          - python3-pip
          - python3-setuptools
          - nvidia-docker2
          - nvidia-driver-470
        state: present
        update_cache: yes
    - name: install Docker module for Python
      pip:
        name:
          - docker
          - docker-compose
    - name: restart docker daemon
      command: systemctl restart docker
    - name: reboot instance so graphics driver is active
      reboot:
    - name: copy files to instance
      copy:
        src: "./{{ item }}"
        dest: /root
      become: yes
      loop:
        - "Dockerfile"
        - "docker-compose.yml"
        - "test-gpu.sh"
    - name: build docker image
      become: yes
      docker_image:
        name: test-1
        build:
          path: /root
          nocache: yes
        source: build
    - name: run docker image
      become: yes
      docker_service:
        project_src: /root
        build:  yes

##### manual steps required:
# 1) run test script

# bugs
# in 'copy nvidia-docker.list we need to get ubuntu20.04 from env vars not my hardcoding
